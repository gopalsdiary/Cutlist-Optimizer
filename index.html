<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CutList Optimizer</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <h1>CutList Optimizer</h1>
                <span class="version">v1.0</span>
            </div>
            <div class="header-actions">
                <button id="calculate-btn"><span class="material-icons">play_arrow</span> Calculate</button>
                <button id="save-btn"><span class="material-icons">save</span> Save</button>
                <button id="load-btn"><span class="material-icons">folder_open</span> Load</button>
                <button id="settings-btn"><span class="material-icons">settings</span> Options</button>
                <button id="save-pdf-btn"><span class="material-icons">picture_as_pdf</span> Save as PDF</button>
            </div>
        </header>

        <main>
            <div class="panels">
                <div class="panel input-panel">
                    <h2><span class="material-icons">dashboard</span> Input Data - Parts & stock list</h2>

                    <div id="parts-section">
                        <h3>Parts List</h3>
                        <div class="table-container">
                            <table id="parts-table">
                                <thead>
                                    <tr>
                                        <th>Label</th>
                                        <th>Length</th>
                                        <th>Width</th>
                                        <th>Quantity</th>
                                        <th>Material</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Parts will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <button id="add-part-btn"><span class="material-icons">add</span> Add Part</button>
                    </div>

                    <div id="stock-section">
                        <h3>Stock Sheets</h3>
                        <div class="table-container">
                            <table id="stock-table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Length</th>
                                        <th>Width</th>
                                        <th>Quantity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Stock sheets will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <button id="add-stock-btn"><span class="material-icons">add</span> Add Stock Sheet</button>
                    </div>
                </div>

                <div class="panel results-panel">
                    <h2><span class="material-icons">view_carousel</span> Cutting Diagrams</h2>
                    <div id="cutting-diagrams">
                        <!-- Cutting diagrams will be rendered here -->
                        <div class="empty-state">
                            <span class="material-icons">info</span>
                            <p>Click "Calculate" to generate cutting diagrams</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel statistics-panel">
                <h2><span class="material-icons">assessment</span> Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Sheets</div>
                        <div class="stat-value" id="total-sheets">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Material Usage</div>
                        <div class="stat-value" id="material-usage">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Waste</div>
                        <div class="stat-value" id="waste-area">0 sq units</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Cuts</div>
                        <div class="stat-value" id="total-cuts">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Use</div>
                        <div class="stat-value" id="total-use">0</div>
                    </div>
                </div>
            </div>

            <div class="panel statistics-panel">
                <h2><span class="material-icons">assessment</span> Global Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Used Stock Sheets</div>
                        <div class="stat-value" id="used-stock-sheets">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Used Area</div>
                        <div class="stat-value" id="total-used-area">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Wasted Area</div>
                        <div class="stat-value" id="total-wasted-area">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Cuts</div>
                        <div class="stat-value" id="total-cuts">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Cut Length</div>
                        <div class="stat-value" id="cut-length">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Optimization Priority</div>
                        <div class="stat-value" id="optimization-priority">-</div>
                    </div>
                </div>
            </div>

            <div class="panel statistics-panel">
                <h2><span class="material-icons">assessment</span> Sheet Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Stock Sheet</div>
                        <div class="stat-value" id="sheet-stock">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Used Area</div>
                        <div class="stat-value" id="sheet-used-area">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Wasted Area</div>
                        <div class="stat-value" id="sheet-wasted-area">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Cuts</div>
                        <div class="stat-value" id="sheet-cuts">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Panels</div>
                        <div class="stat-value" id="sheet-panels">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Wasted Panels</div>
                        <div class="stat-value" id="sheet-wasted-panels">-</div>
                    </div>
                </div>
            </div>

            <div class="panel statistics-panel">
                <h2><span class="material-icons">error</span> Unable to Fit</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Panel</div>
                        <div class="stat-value" id="unable-panel">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Qty</div>
                        <div class="stat-value" id="unable-qty">-</div>
                    </div>
                </div>
            </div>

            <div class="panel statistics-panel">
                <h2><span class="material-icons">content_cut</span> Cuts</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">#</div>
                        <div class="stat-value" id="cut-number">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Panel</div>
                        <div class="stat-value" id="cut-panel">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Cut</div>
                        <div class="stat-value" id="cut-cut">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Result</div>
                        <div class="stat-value" id="cut-result">-</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for adding/editing parts -->
    <div class="modal" id="part-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="part-modal-title">Add New Part</h2>
            <form id="part-form">
                <input type="hidden" id="part-id">
                <div class="form-group">
                    <label for="part-label">Label:</label>
                    <input type="text" id="part-label" required>
                </div>
                <div class="form-group">
                    <label for="part-length">Length (in):</label>
                    <input type="number" id="part-length" min="1" required>
                </div>
                <div class="form-group">
                    <label for="part-width">Width (in):</label>
                    <input type="number" id="part-width" min="1" required>
                </div>
                <div class="form-group">
                    <label for="part-quantity">Quantity:</label>
                    <input type="number" id="part-quantity" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="part-material">Material:</label>
                    <select id="part-material">
                        <option value="plywood">Plywood</option>
                        <option value="mdf">MDF</option>
                        <option value="particle-board">Particle Board</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit">Save</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for adding/editing stock sheets -->
    <div class="modal" id="stock-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="stock-modal-title">Add New Stock Sheet</h2>
            <form id="stock-form">
                <input type="hidden" id="stock-id">
                <div class="form-group">
                    <label for="stock-material">Material:</label>
                    <select id="stock-material">
                        <option value="plywood">Plywood</option>
                        <option value="mdf">MDF</option>
                        <option value="particle-board">Particle Board</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="stock-length">Length (in):</label>
                    <input type="number" id="stock-length" min="1" value="2440" required>
                </div>
                <div class="form-group">
                    <label for="stock-width">Width (in):</label>
                    <input type="number" id="stock-width" min="1" value="1220" required>
                </div>
                <div class="form-group">
                    <label for="stock-quantity">Quantity:</label>
                    <input type="number" id="stock-quantity" min="1" value="1" required>
                </div>
                <div class="form-actions">
                    <button type="submit">Save</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Options Modal -->
    <div class="modal" id="options-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Cutting Options</h2>
            <form id="options-form">
                <div class="form-group">
                    <label for="kerf-width">Saw Kerf Width (mm):</label>
                    <input type="number" id="kerf-width" min="0" step="0.1" value="3.5">
                </div>
                <div class="form-group">
                    <label for="optimization-priority">Optimization Priority:</label>
                    <select id="optimization-priority">
                        <option value="material">Minimize Material Use</option>
                        <option value="cuts">Minimize Number of Cuts</option>
                    </select>
                </div>
                <div class="form-group checkbox">
                    <input type="checkbox" id="allow-rotation" checked>
                    <label for="allow-rotation">Allow Part Rotation</label>
                </div>
                <div class="form-group checkbox">
                    <input type="checkbox" id="consider-grain">
                    <label for="consider-grain">Consider Grain Direction</label>
                </div>
                <div class="form-actions">
                    <button type="submit">Apply</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script>
        // Calculate the cutlist
        function calculateCutlist() {
            console.log("Starting cutlist calculation...");
            console.log("Parts:", parts);
            console.log("Stock Sheets:", stockSheets);

            // Prepare the cutting diagrams container
            const diagramsContainer = document.getElementById('cutting-diagrams');
            diagramsContainer.innerHTML = '';

            // First, create a list of all parts with their repetitions
            let allPartInstances = [];
            parts.forEach(part => {
                for (let i = 0; i < part.quantity; i++) {
                    allPartInstances.push({
                        ...part,
                        instanceId: `${part.id}-${i}`
                    });
                }
            });
            console.log("All Part Instances:", allPartInstances);

            // Sort parts by area (largest first) for better packing
            allPartInstances.sort((a, b) => {
                const areaA = a.length * a.width;
                const areaB = b.length * b.width;
                return areaB - areaA;
            });
            console.log("Sorted Part Instances:", allPartInstances);

            // Group parts by material
            const partsByMaterial = {};
            allPartInstances.forEach(part => {
                if (!partsByMaterial[part.material]) {
                    partsByMaterial[part.material] = [];
                }
                partsByMaterial[part.material].push(part);
            });
            console.log("Parts Grouped by Material:", partsByMaterial);

            // Initialize statistics
            let totalSheets = 0;
            let totalArea = 0;
            let usedArea = 0;
            let totalCuts = 0;

            // Process each material type
            Object.keys(partsByMaterial).forEach(material => {
                const materialParts = partsByMaterial[material];
                console.log(`Processing material: ${material}`, materialParts);

                // Find matching stock sheets
                const availableSheets = stockSheets.filter(sheet => sheet.material === material);
                console.log(`Available stock sheets for material ${material}:`, availableSheets);

                if (availableSheets.length === 0) {
                    alert(`No stock sheets available for material: ${material}`);
                    return;
                }

                // Use the largest sheet available for this material
                let sheetToUse = availableSheets.reduce((prev, current) => {
                    return (prev.length * prev.width > current.length * current.width) ? prev : current;
                });
                console.log(`Using stock sheet for material ${material}:`, sheetToUse);

                // Clone the sheet for our calculations to avoid modifying the original
                const sheetProperties = { ...sheetToUse };

                // Simple bin packing algorithm (greedy)
                let sheetsUsed = 0;
                let remainingParts = [...materialParts];

                while (remainingParts.length > 0 && sheetsUsed < sheetProperties.quantity) {
                    totalSheets++;
                    sheetsUsed++;

                    // Create a new sheet layout
                    const sheetLayout = {
                        material: sheetProperties.material,
                        length: sheetProperties.length,
                        width: sheetProperties.width,
                        parts: [],
                        cuts: []
                    };

                    // The available area is represented as a list of free rectangles
                    let freeRects = [{ 
                        x: 0, 
                        y: 0, 
                        width: sheetProperties.width, 
                        length: sheetProperties.length 
                    }];
                    console.log(`Initial free rectangles for sheet ${sheetsUsed}:`, freeRects);

                    // Try to place each part
                    let partIndex = 0;
                    while (partIndex < remainingParts.length) {
                        const part = remainingParts[partIndex];
                        console.log(`Attempting to place part:`, part);

                        // Try to place the part in any of the free rectangles
                        let placed = false;
                        let rectIndex = 0;

                        while (rectIndex < freeRects.length && !placed) {
                            const rect = freeRects[rectIndex];
                            console.log(`Checking rectangle:`, rect);

                            // Can the part fit in this rectangle?
                            let fits = false;
                            let partLength = part.length;
                            let partWidth = part.width;
                            let rotated = false;

                            if (partLength <= rect.length && partWidth <= rect.width) {
                                fits = true;
                            } else if (options.allowRotation && partWidth <= rect.length && partLength <= rect.width) {
                                // Try rotated if allowed
                                fits = true;
                                rotated = true;
                                [partLength, partWidth] = [partWidth, partLength];
                            }

                            if (fits) {
                                console.log(`Part fits in rectangle. Placing part:`, part);

                                // Place the part in the top-left corner of this rectangle
                                const placedPart = {
                                    id: part.instanceId,
                                    label: part.label,
                                    x: rect.x,
                                    y: rect.y,
                                    width: partWidth,
                                    length: partLength,
                                    rotated
                                };

                                sheetLayout.parts.push(placedPart);
                                console.log(`Placed part:`, placedPart);

                                // Update free rectangles by splitting the current one
                                // Remove current rectangle
                                freeRects.splice(rectIndex, 1);

                                // Add new free rectangles - right of part
                                if (rect.x + rect.width > placedPart.x + placedPart.width) {
                                    freeRects.push({
                                        x: placedPart.x + placedPart.width,
                                        y: rect.y,
                                        width: rect.width - (placedPart.x + placedPart.width - rect.x),
                                        length: rect.length
                                    });
                                }

                                // Add new free rectangles - below part
                                if (rect.y + rect.length > placedPart.y + placedPart.length) {
                                    freeRects.push({
                                        x: rect.x,
                                        y: placedPart.y + placedPart.length,
                                        width: rect.width,
                                        length: rect.length - (placedPart.y + placedPart.length - rect.y)
                                    });
                                }

                                // Remove the part from remaining parts
                                remainingParts.splice(partIndex, 1);

                                // Part was placed successfully
                                placed = true;
                                usedArea += partLength * partWidth;

                            } else {
                                // Try next rectangle
                                rectIndex++;
                            }
                        }

                        if (!placed) {
                            console.warn(`Part could not be placed:`, part);
                            partIndex++;
                        }
                    }

                    console.log(`Final free rectangles for sheet ${sheetsUsed}:`, freeRects);
                    console.log(`Sheet layout for sheet ${sheetsUsed}:`, sheetLayout);

                    // Calculate statistics for this sheet
                    const sheetArea = sheetProperties.length * sheetProperties.width;
                    totalArea += sheetArea;

                    // Calculate sheet material utilization
                    const sheetUsedArea = sheetLayout.parts.reduce((sum, part) => sum + (part.length * part.width), 0);
                    const utilization = (sheetUsedArea / sheetArea) * 100;

                    // Render this sheet layout
                    renderCuttingDiagram(sheetLayout, sheetsUsed, utilization);
                }
            });

            // Update statistics
            console.log("Calculation complete. Statistics:");
            console.log("Total Sheets Used:", totalSheets);
            console.log("Total Material Area:", totalArea);
            console.log("Total Used Area:", usedArea);
            console.log("Total Cuts:", totalCuts);

            document.getElementById('total-sheets').textContent = totalSheets;
            document.getElementById('material-usage').textContent = Math.round((usedArea / totalArea) * 100) + '%';
            document.getElementById('waste-area').textContent = Math.round(totalArea - usedArea) + ' sq mm';
            document.getElementById('total-cuts').textContent = totalCuts;
        }
    </script>
</body>
</html>